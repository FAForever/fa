--   - Children: table: 206A3EB0
--   -    10: table: 206A3758
--   -       Children: table: 14ECEE38
--   -          1: table: 14ECE960
--   -             Name: TotalCells
--   -             Type: Integer
--   -             Value: 427
--   -          2: table: 14ECE488
--   -             Name: Vertices
--   -             Type: Integer
--   -             Value: 1488
--   -          3: table: 14ECED48
--   -             Name: Triangles
--   -             Type: Integer
--   -             Value: 496
--   -       Name: Shoreline
--   -    11: table: 206A3D98
--   -       Children: table: 14ECE118
--   -          1: table: 14ECE578
--   -             Name: Total
--   -             Type: Integer
--   -             Value: 2
--   -       Name: Vision
--   -    12: table: 14ECE7A8
--   -       Name: Tick
--   -       Type: Integer
--   -       Value: 14
--   -    13: table: 14ECEB68
--   -       Children: table: 14ECE0C8
--   -          1: table: 14ECEF00
--   -             Children: table: 14ECE730
--   -                1: table: 14ECE5A0
--   -                   Name: Position
--   -                   Type: String
--   -                   Value: x=338.09,y=24.16,z=436.07
--   -                2: table: 206A39D8
--   -                   Name: Elevation
--   -                   Type: Float
--   -                   Value: 24.158401489258
--   -                3: table: 206A38C0
--   -                   Name: OCell
--   -                   Type: String
--   -                   Value: x=338,z=436
--   -                4: table: 14ECE898
--   -                   Name: LODMetric
--   -                   Type: Float
--   -                   Value: 450.86434936523
--   -             Name: Cursor
--   -          2: table: 14ECE460
--   -             Name: FocusDistance
--   -             Type: Float
--   -             Value: 516.88946533203
--   -       Name: Camera
--   -    1: table: 206A34B0
--   -       Children: table: 206A3FA0
--   -          10: table: 206A37D0
--   -             Name: class Moho::CAiPersonality
--   -             Type: Integer
--   -             Value: 7
--   -          11: table: 206A3848
--   -             Name: class Moho::CPlatoon
--   -             Type: Integer
--   -             Value: 7
--   -          12: table: 206A3C58
--   -             Name: class Moho::Entity
--   -             Type: Integer
--   -             Value: 8471
--   -          13: table: 206A3578
--   -             Name: class Moho::Prop
--   -             Type: Integer
--   -             Value: 8462
--   -          14: table: 206A3488
--   -             Name: class Moho::CDecalHandle
--   -             Type: Integer
--   -             Value: 124
--   -          15: table: 206A3B40
--   -             Name: class Moho::Unit
--   -             Type: Integer
--   -             Value: 4
--   -          16: table: 206A32A8
--   -             Name: class Moho::CAiNavigatorImpl
--   -             Type: Integer
--   -             Value: 4
--   -          17: table: 206A3280
--   -             Name: class Moho::CAiSteeringImpl
--   -             Type: Integer
--   -             Value: 4
--   -          18: table: 206A3820
--   -             Name: class Moho::LAiAttackerImpl
--   -             Type: Integer
--   -             Value: 4
--   -          19: table: 206A30C8
--   -             Name: class Moho::CFireWeaponTask
--   -             Type: Integer
--   -             Value: 24
--   -          1: table: 206A3258
--   -             Name: class Moho::CTask
--   -             Type: Integer
--   -             Value: 8583
--   -          20: table: 206A3F50
--   -             Name: class Moho::CAcquireTargetTask
--   -             Type: Integer
--   -             Value: 15
--   -          21: table: 206A3BE0
--   -             Name: class Moho::CCommandTask
--   -             Type: Integer
--   -             Value: 4
--   -          22: table: 206A35F0
--   -             Name: class Moho::IEffect
--   -             Type: Integer
--   -             Value: 285
--   -          23: table: 206A3028
--   -             Name: class Moho::CUnitCommand
--   -             Type: Integer
--   -             Value: 0
--   -          24: table: 206A3618
--   -             Name: class Moho::ReconBlip
--   -             Type: Integer
--   -             Value: 4
--   -          25: table: 206A36B8
--   -             Name: class Moho::Projectile
--   -             Type: Integer
--   -             Value: 0
--   -          26: table: 206A3AF0
--   -             Name: class Moho::CDamage
--   -             Type: Integer
--   -             Value: 0
--   -          27: table: 206A3A28
--   -             Name: class Moho::CollisionBeamEntity
--   -             Type: Integer
--   -             Value: 1
--   -          28: table: 206A3370
--   -             Name: class Moho::MotorFallDown
--   -             Type: Integer
--   -             Value: 0
--   -          29: table: 206A39B0
--   -             Name: class Moho::MotorSinkAway
--   -             Type: Integer
--   -             Value: 0
--   -          2: table: 206A3D70
--   -             Name: class Moho::ScrDiskWatcherTask
--   -             Type: Integer
--   -             Value: 3
--   -          30: table: 206A3AA0
--   -             Name: class Moho::CWaitForTask
--   -             Type: Integer
--   -             Value: 0
--   -          3: table: 206A3690
--   -             Name: class Moho::CTaskThread
--   -             Type: Integer
--   -             Value: 8583
--   -          4: table: 206A3910
--   -             Name: class Moho::CScriptObject
--   -             Type: Integer
--   -             Value: 9706
--   -          5: table: 206A3870
--   -             Name: class Moho::CScriptEvent
--   -             Type: Integer
--   -             Value: 60
--   -          6: table: 206A3CF8
--   -             Name: class Moho::CLuaTask
--   -             Type: Integer
--   -             Value: 54
--   -          7: table: 206A3438
--   -             Name: class Moho::RRuleGameRules
--   -             Type: Integer
--   -             Value: 1
--   -          8: table: 206A34D8
--   -             Name: class Moho::RBlueprint
--   -             Type: Integer
--   -             Value: 5267
--   -          9: table: 206A3190
--   -             Name: class Moho::CAiBrain
--   -             Type: Integer
--   -             Value: 7
--   -       Name: Instance Counts
--   -    2: table: 206A3168
--   -       Children: table: 206A32D0
--   -          1: table: 206A31B8
--   -             Name: ListenerPos
--   -             Type: String
--   -             Value: x=256.00,y=741.65,z=256.00
--   -          2: table: 206A3A00
--   -             Name: PendingDestroy
--   -             Type: Integer
--   -             Value: 0
--   -          3: table: 206A3E60
--   -             Name: LimitedLoop
--   -             Type: Integer
--   -             Value: 0
--   -          4: table: 206A3A78
--   -             Name: StartEntityLoop
--   -             Type: Integer
--   -             Value: 0
--   -          5: table: 206A3B68
--   -             Name: StopEntityLoop
--   -             Type: Integer
--   -             Value: 0
--   -          6: table: 206A3000
--   -             Name: ActiveEntityLoops
--   -             Type: Integer
--   -             Value: 0
--   -       Name: Sound
--   -    3: table: 206A3078
--   -       Children: table: 206A3460
--   -          1: table: 206A3D48
--   -             Name: Reserved
--   -             Type: String
--   -             Value: 512.0M
--   -          2: table: 206A3CD0
--   -             Name: Committed
--   -             Type: String
--   -             Value: 373.7M
--   -          3: table: 206A3E88
--   -             Name: Total
--   -             Type: String
--   -             Value: 448.0M
--   -          4: table: 206A3320
--   -             Name: InSmallBlocks
--   -             Type: String
--   -             Value: 18.21M
--   -          5: table: 206A3988
--   -             Name: InUse
--   -             Type: String
--   -             Value: 355.4M
--   -          6: table: 206A3F00
--   -             Name: TotalCheck
--   -             Type: String
--   -             Value: 373.7M
--   -       Name: Heap
--   -    4: table: 206A3BB8
--   -       Children: table: 206A3B18
--   -          1: table: 206A30F0
--   -             Name: Time
--   -             Type: Float
--   -             Value: 17.755283355713
--   -          2: table: 206A3898
--   -             Name: FPS
--   -             Type: Float
--   -             Value: 56.321266174316
--   -       Name: Frame
--   -    5: table: 206A3398
--   -       Children: table: 206A30A0
--   -          10: table: 206A3960
--   -             Name: FlatDecals
--   -             Type: Integer
--   -             Value: 0
--   -          11: table: 206A3C30
--   -             Name: Decals
--   -             Type: Integer
--   -             Value: 0
--   -          12: table: 206A3730
--   -             Name: ActiveEmitters
--   -             Type: Integer
--   -             Value: 0
--   -          1: table: 206A3C08
--   -             Name: PresentCount
--   -             Type: Integer
--   -             Value: 0
--   -          2: table: 206A3780
--   -             Name: UnitCount
--   -             Type: Integer
--   -             Value: 0
--   -          3: table: 206A35C8
--   -             Name: PrimitiveCount
--   -             Type: Integer
--   -             Value: 0
--   -          4: table: 206A3550
--   -             Name: VertexCount
--   -             Type: Integer
--   -             Value: 0
--   -          5: table: 206A3640
--   -             Name: DrawPrimCalls
--   -             Type: Integer
--   -             Value: 0
--   -          6: table: 206A3528
--   -             Name: UnitPrimitiveCount
--   -             Type: Integer
--   -             Value: 0
--   -          7: table: 206A3938
--   -             Name: UnitVertexCount
--   -             Type: Integer
--   -             Value: 0
--   -          8: table: 206A3A50
--   -             Name: QuadBatchCount
--   -             Type: Integer
--   -             Value: 0
--   -          9: table: 206A3668
--   -             Name: TextBatchCount
--   -             Type: Integer
--   -             Value: 0
--   -       Name: Render
--   -    6: table: 206A3050
--   -       Children: table: 206A3C80
--   -          1: table: 206A31E0
--   -             Name: Prop
--   -             Type: Integer
--   -             Value: 8462
--   -          2: table: 206A33E8
--   -             Name: Unit
--   -             Type: Integer
--   -             Value: 4
--   -          3: table: 206A35A0
--   -             Name: Other
--   -             Type: Integer
--   -             Value: 1
--   -          4: table: 206A3348
--   -             Name: Blip
--   -             Type: Integer
--   -             Value: 4
--   -          5: table: 206A38E8
--   -             Name: Projectile
--   -             Type: Integer
--   -             Value: 0
--   -       Name: EntityCount
--   -       Type: Integer
--   -       Value: 8471
--   -    7: table: 206A33C0
--   -       Children: table: 206A3140
--   -          1: table: 206A37F8
--   -             Name: Sync
--   -             Type: Float
--   -             Value: 4.6242849322719e-044
--   -          2: table: 206A3B90
--   -             Name: Dispatch
--   -             Type: Float
--   -             Value: 2.092138607237e-042
--   -       Name: Sim
--   -    8: table: 206A3F28
--   -       Children: table: 206A3E38
--   -          1: table: 206A3410
--   -             Children: table: 206A3E10
--   -                1: table: 206A3208
--   -                   Name: Count
--   -                   Type: Integer
--   -                   Value: 9
--   -             Name: Entity
--   -          2: table: 206A3DE8
--   -             Name: Count
--   -             Type: Integer
--   -             Value: 0
--   -       Name: Sync
--   -    9: table: 206A3F78
--   -       Children: table: 206A3230
--   -          1: table: 206A3500
--   -             Children: table: 206A3CA8
--   -                1: table: 206A37A8
--   -                   Name: NumTickers
--   -                   Type: Integer
--   -                   Value: 2
--   -             Name: SessionTick
--   -       Name: UserSync
--   - Name: Root
local engineStats = __EngineStats

--   - 1: table: 1DB2C7F8
--   -    authorizedCommandSources: table: 1DB2C0F0
--   -       1: 1
--   -    civilian: false
--   -    color: ffffffff
--   -    faction: 2
--   -    human: true
--   -    iconColor: ffffffff
--   -    name: ARMY_1
--   -    nickname: Jip
--   -    outOfGame: false
--   -    showScore: true
--   - 2: table: 1DB2C2F8
--   -    authorizedCommandSources: table: 1DB2CF78
--   -       1: 1
--   -    civilian: false
--   -    color: ff436eee
--   -    faction: 1
--   -    human: false
--   -    iconColor: ff436eee
--   -    name: ARMY_2
--   -    nickname: Yare (AI: Easy)
--   -    outOfGame: false
--   -    showScore: true
--   - 3: table: 1DB2C898
--   -    authorizedCommandSources: table: 1DB2C988
--   -       1: 1
--   -    civilian: false
--   -    color: ffe80a0a
--   -    faction: 0
--   -    human: false
--   -    iconColor: ffe80a0a
--   -    name: ARMY_3
--   -    nickname: Lundquist (AI: Easy)
--   -    outOfGame: false
--   -    showScore: true
--   - 4: table: 1DB2C1B8
--   -    authorizedCommandSources: table: 1DB2C910
--   -       1: 1
--   -    civilian: false
--   -    color: ff2929e1
--   -    faction: 1
--   -    human: false
--   -    iconColor: ff2929e1
--   -    name: ARMY_4
--   -    nickname: Pheobe (AI: Easy)
--   -    outOfGame: false
--   -    showScore: true
--   - 5: table: 1DB2CE10
--   -    authorizedCommandSources: table: 1DB2C848
--   -       1: 1
--   -    civilian: true
--   -    color: ffff3030
--   -    faction: 4
--   -    human: false
--   -    iconColor: ffff3030
--   -    name: ARMY_17
--   -    nickname: civilian
--   -    outOfGame: false
--   -    showScore: true
--   - 6: table: 1DB2C3E8
--   -    authorizedCommandSources: table: 1DB2C168
--   -       1: 1
--   -    civilian: true
--   -    color: ffff3030
--   -    faction: 4
--   -    human: false
--   -    iconColor: ffff3030
--   -    name: NEUTAL_CIVILIAN
--   -    nickname: civilian
--   -    outOfGame: false
--   -    showScore: true
--   - 7: table: 1DB2CA00
--   -    authorizedCommandSources: table: 1DB2C370
--   -       1: 1
--   -    civilian: true
--   -    color: ffff3030
--   -    faction: 4
--   -    human: false
--   -    iconColor: ffff3030
--   -    name: JIP
--   -    nickname: civilian
--   -    outOfGame: false
--   -    showScore: true
local armies = GetArmiesTable().armiesTable

--   - Configurations: table: 1330B208
--   -    standard: table: 1330B230
--   -       customprops: table: 1330B258
--   -          ExtraArmies: ARMY_17 NEUTAL_CIVILIAN JIP
--   -       teams: table: 1330B2D0
--   -          1: table: 1330B2F8
--   -             armies: table: 1330B708
--   -                1: ARMY_1
--   -                2: ARMY_2
--   -                3: ARMY_3
--   -                4: ARMY_4
--   -             name: FFA
--   - Options: table: 1330E7D0
--   -    AIBuilderNameDebug: off
--   -    AIDebugDisplay: displayOff
--   -    AIEndlessGameLoop: off
--   -    AIGameenderStart: 20
--   -    AIMapMarker: all
--   -    AIOverwhelmDelay: 20
--   -    AIOverwhelmIncrease: 0.025000000372529
--   -    AIPLatoonNameDebug: off
--   -    AIPathingDebug: off
--   -    AIReplacement: Off
--   -    AIUnitCap: 0
--   -    AllowObservers: true
--   -    AutoTeams: pvsi
--   -    BuildMult: 2.0
--   -    CarePackagesAmount: 1
--   -    CarePackagesCurve: 1
--   -    CarePackagesRate: 40
--   -    CheatMult: 2.0
--   -    CheatsEnabled: true
--   -    CivilianAlliance: enemy
--   -    ClanTags: table: 1330E820
--   -       Jip:
--   -    DelayUntilNextWave: 0.5
--   -    DisconnectionDelay02: 90
--   -    DmgBonus: 1
--   -    FogOfWar: explored
--   -    GameSpeed: normal
--   -    HPBonus: 4
--   -    HivesPerPlayer: 120
--   -    HoldTime: 35
--   -    LandExpansionsAllowed: 5
--   -    MainBuildingHP: 50
--   -    ManualUnitShare: all
--   -    MySpecialKey1: off
--   -    NavalExpansionsAllowed: 4
--   -    NoRushOption: Off
--   -    NukeStrikeEvery: 2
--   -    NukesPerStrike: 2
--   -    OmniCheat: on
--   -    PrebuiltUnits: Off
--   -    RandomMap: Off
--   -    Ratings: table: 1330E118
--   -       Jip: 0
--   -    RevealCivilians: Yes
--   -    ScenarioFile: /maps/adaptive_archsimkats_valley.v0003/adaptive_archsimkats_valley_scenario.lua
--   -    Score: yes
--   -    Share: ShareUntilDeath
--   -    ShareUnitCap: none
--   -    ShrinkingDelay: 120
--   -    ShrinkingRate: 140
--   -    ShrinkingType: pseudorandom
--   -    TMLRandom: 0
--   -    TargetArmy: neutral_army
--   -    TeamLock: locked
--   -    TeamSpawn: fixed
--   -    Timeouts: 3
--   -    TreeRegrowSpeed: 1
--   -    UnitCap: 1000
--   -    UnitsPerWave: 35
--   -    Unranked: No
--   -    Victory: sandbox
--   -    WavesStartTime: 5
--   -    crazyrush_mexes: 1
--   -    dynamic_spawn: 1
--   -    naturalReclaimModifier: 1
--   - PlayableAreaHeight: 512
--   - PlayableAreaWidth: 512
--   - description: A gorgeous valley is turned upside down into a battle ground. Map made by (Jip) Willem Bart Wijnia. Thanks to Archimiskat and the community for their input. You can view the latest version on: https://gitlab.com/w.b.wijnia/archimiskats-valley
--   - map: /maps/adaptive_archsimkats_valley.v0003/Adaptive_Archsimkats_Valley.scmap
--   - map_version: 3
--   - name: Adaptive Archsimkats Valley
--   - norushoffsetX_ARMY_1: 0
--   - norushoffsetX_ARMY_2: 0
--   - norushoffsetX_ARMY_3: 0
--   - norushoffsetX_ARMY_4: 0
--   - norushoffsetY_ARMY_1: 0
--   - norushoffsetY_ARMY_2: 0
--   - norushoffsetY_ARMY_3: 0
--   - norushoffsetY_ARMY_4: 0
--   - norushradius: 100
--   - preview:
--   - save: /maps/adaptive_archsimkats_valley.v0003/Adaptive_Archsimkats_Valley_save.lua
--   - script: /maps/adaptive_archsimkats_valley.v0003/Adaptive_Archsimkats_Valley_script.lua
--   - size: table: 13310F00
--   -    1: 512
--   -    2: 512
--   - starts: true
--   - type: skirmish
local session = SessionGetScenarioInfo()

--   - 1: table: 18CE6708
--   -    authorizedCommandSources: table: 18CE6730
--   -       1: 1
--   -    connected: true
--   -    ejectedBy: table: 18CE65F0
--   -    local: true
--   -    maxSP: 50
--   -    name: Jip
--   -    ping: 0
--   -    quiet: 0
--   -    uid: 0
local clients = GetSessionClients()

local samples = {}
for k = 1, 21 do
    samples[k] = {
        Samples = 0
    }
end

---@class UIPerformanceMetrics
---@field SkirmishWithAI UIPerformanceMetricsArray
---@field Skirmish UIPerformanceMetricsArray
---@field Campaign UIPerformanceMetricsArray

---@class UIPerformanceMetricsArray
---@field [1]  UIPerformanceMetricsEntry
---@field [2]  UIPerformanceMetricsEntry
---@field [3]  UIPerformanceMetricsEntry
---@field [4]  UIPerformanceMetricsEntry
---@field [5]  UIPerformanceMetricsEntry
---@field [6]  UIPerformanceMetricsEntry
---@field [7]  UIPerformanceMetricsEntry
---@field [8]  UIPerformanceMetricsEntry
---@field [9]  UIPerformanceMetricsEntry
---@field [10] UIPerformanceMetricsEntry
---@field [11] UIPerformanceMetricsEntry
---@field [12] UIPerformanceMetricsEntry
---@field [13] UIPerformanceMetricsEntry
---@field [14] UIPerformanceMetricsEntry
---@field [15] UIPerformanceMetricsEntry
---@field [16] UIPerformanceMetricsEntry
---@field [17] UIPerformanceMetricsEntry
---@field [18] UIPerformanceMetricsEntry
---@field [19] UIPerformanceMetricsEntry
---@field [20] UIPerformanceMetricsEntry
---@field [21] UIPerformanceMetricsEntry

---@class UIPerformanceMetricsEntry
---@field Samples number
---@field UnitCount? { Min: number, Max: number}

local function StoreSamples(exitType)

    -- this is usually testing, no need to keep track of that
    -- if exitType == 'RestartSession' then
    --     return
    -- end

    -- get / store the preference table

    -- determine game flags
    local isSkirmish = session.type == 'skirmish'
    local hasAI = false
    for k, army in armies do
        if (not army.civilian) and (not army.human) then
            hasAI = true
            break
        end
    end

    -- determine identifier based on game flags
    local identifier = 'Campaign'
    if isSkirmish then
        if hasAI then
            identifier = 'SkirmishWithAI'
        else
            identifier = 'Skirmish'
        end
    end

    -- retrieve and update data
    ---@type UIPerformanceMetrics
    local data = GetPreference('PerformanceTrackingV2') or {}
    local mapData = data[identifier]
    if mapData then
        for k = 1, 21 do

            if samples[k].Samples > 0 then
                if mapData[k].Samples > 0 then
                    -- combine them
                    mapData[k].UnitCount.Min = math.min(samples[k].UnitCount.Min, mapData[k].UnitCount.Min)
                    mapData[k].UnitCount.Max = math.max(samples[k].UnitCount.Max, mapData[k].UnitCount.Max)

                    -- slowly converge to exclude outliers over time
                    local avgUnitCount = 0.5 * (mapData[k].UnitCount.Min + mapData[k].UnitCount.Max)

                    -- linear interpolation
                    mapData[k].UnitCount.Min = 0.9 * mapData[k].UnitCount.Min + 0.1 * avgUnitCount
                    mapData[k].UnitCount.Max = 0.9 * mapData[k].UnitCount.Max + 0.1 * avgUnitCount
                    mapData[k].Samples = mapData[k].Samples + samples[k].Samples
                else
                    -- first time at this rate, just take them as ground truth
                    mapData[k].UnitCount = {}
                    mapData[k].UnitCount.Min = samples[k].UnitCount.Min
                    mapData[k].UnitCount.Max = samples[k].UnitCount.Max
                    mapData[k].Samples = samples[k].Samples
                end
            end
        end

        mapData.Samples = mapData.Samples + 1
    else
        -- use as ground truth
        data[identifier] = samples
        data[identifier].Samples = 1
    end

    -- store data
    SetPreference('PerformanceTrackingV2', data)
end

local function PerformanceTrackingThread()

    local focusArmy = GetFocusArmy()

    -- # Wait until the game is ready

    WaitSeconds(1.0)

    -- # Add on exit callbacks to store information

    local AddOnExitCallback = import("/lua/ui/override/exit.lua").AddOnExitCallback
    AddOnExitCallback('PerformanceTracking', StoreSamples)

    -- # Start sampling!

    while true do

        -- # Wait between samples

        WaitSeconds(1.0)

        -- # Refresh data

        clients = GetSessionClients()
        local engineStats = __EngineStats

        -- # Retrieve sim rate

        local rate = 0
        local army = armies[focusArmy]
        for k, client in clients do
            if client.name == army.nickname then
                rate = client.maxSP or -1
            end
        end

        rate = math.clamp(rate, -10, 10) + 11

        -- # Retrieve engine statistics

        local unitCount = 0

        -- their order is not set in stone, hence the extensive search
        for k, stat in engineStats.Children do
            if stat.Name == 'EntityCount' then
                for _, entry in stat.Children do
                    if entry.Name == 'Unit' then
                        unitCount = entry.Value
                    end
                end
            end
        end

        -- # Store the sample

        local sample = samples[rate]
        if sample.Samples > 0 then
            sample.UnitCount.Min = math.min(sample.UnitCount.Min, unitCount)
            sample.UnitCount.Max = math.max(sample.UnitCount.Max, unitCount)
        else
            sample.UnitCount = {}
            sample.UnitCount.Min = unitCount
            sample.UnitCount.Max = unitCount
        end

        sample.Samples = sample.Samples + 1
    end
end

ForkThread(PerformanceTrackingThread)
